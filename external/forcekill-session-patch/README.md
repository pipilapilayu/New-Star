This patch works, but it's ugly. Need to rewrite